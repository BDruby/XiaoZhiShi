{% extends "admin/base.html" %}

{% block title %}编辑文章 - 管理后台{% endblock %}

{% block content %}
<div class="animate-fade-in">
    <div class="md:flex md:items-center md:justify-between mb-8">
        <div class="flex-1 min-w-0">
            <h2
                class="text-3xl font-bold leading-7 text-transparent bg-clip-text bg-gradient-to-r from-primary-600 to-purple-600 sm:text-4xl sm:truncate">
                编辑文章
            </h2>
            <p class="mt-1 text-sm text-gray-500">编辑文章内容和属性</p>
        </div>
        <div class="mt-4 flex md:mt-0 md:ml-4">
            <a href="{{ url_for('admin.posts') }}"
                class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-full shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all">
                返回列表
            </a>
        </div>
    </div>

    <div class="bg-white shadow-lg rounded-2xl p-8 border border-gray-100">
        <form method="POST">
            <div class="grid grid-cols-1 gap-y-8 gap-x-6 sm:grid-cols-6">
                <!-- 标题 -->
                <div class="sm:col-span-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">标题</label>
                    <input type="text" name="title" value="{{ post.title }}" required
                        class="block w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm transition-shadow">
                </div>

                <!-- URL别名 -->
                <div class="sm:col-span-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">URL别名</label>
                    <div class="mt-1 flex rounded-xl shadow-sm">
                        <span
                            class="inline-flex items-center px-4 rounded-l-xl border border-r-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">
                            /post/
                        </span>
                        <input type="text" name="slug" value="{{ post.slug }}" required
                            class="flex-1 block w-full px-4 py-3 min-w-0 border border-gray-300 rounded-none rounded-r-xl focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm transition-shadow">
                    </div>
                </div>

                <!-- 分类 -->
                <div class="sm:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">分类</label>
                    <select name="category_id"
                        class="block w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm transition-shadow">
                        <option value="">请选择分类</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" {{ 'selected' if post.category_id==category.id }}>{{
                            category.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- 状态 -->
                <div class="sm:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">状态</label>
                    <select name="status"
                        class="block w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm transition-shadow">
                        <option value="draft" {{ 'selected' if post.status=='draft' }}>草稿</option>
                        <option value="published" {{ 'selected' if post.status=='published' }}>已发布</option>
                        <option value="archived" {{ 'selected' if post.status=='archived' }}>已归档</option>
                    </select>
                </div>

                <!-- 摘要 -->
                <div class="sm:col-span-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">摘要</label>
                    <textarea name="excerpt" rows="3"
                        class="block w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm transition-shadow">{{ post.excerpt }}</textarea>
                </div>

                <!-- 内容 -->
                <div class="sm:col-span-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">内容</label>
                    <div
                        class="border border-gray-300 rounded-xl overflow-hidden shadow-sm focus-within:ring-2 focus-within:ring-primary-500 focus-within:border-primary-500 transition-shadow">
                        <div id="toolbar-container" class="border-b border-gray-300 bg-gray-50"></div>
                        <div id="editor" style="min-height: 500px;"></div>
                    </div>
                    <input type="hidden" id="content" name="content" required value="{{ post.content }}">
                </div>

                <!-- 标签 -->
                <div class="sm:col-span-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">标签</label>
                    <div class="mt-1 p-4 border border-gray-300 rounded-xl bg-gray-50 shadow-inner">
                        <!-- 已选标签显示区域 -->
                        <div id="selected-tags" class="mb-3 flex flex-wrap gap-2 min-h-[2.5rem]">
                            {% for tag in post.tags %}
                            <span
                                class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-white text-primary-700 border border-primary-200 shadow-sm tag-item"
                                data-tag-id="{{ tag.id }}">
                                {{ tag.name }}
                                <button type="button"
                                    class="flex-shrink-0 ml-1.5 h-4 w-4 rounded-full inline-flex items-center justify-center text-primary-400 hover:bg-primary-100 hover:text-primary-600 focus:outline-none tag-remove transition-colors"
                                    data-tag-id="{{ tag.id }}">
                                    <span class="sr-only">移除标签</span>
                                    <svg class="h-3 w-3" stroke="currentColor" fill="none" viewBox="0 0 8 8">
                                        <path stroke-linecap="round" stroke-width="1.5" d="M1 1l6 6m0-6L1 7" />
                                    </svg>
                                </button>
                                <input type="hidden" name="tag_ids" value="{{ tag.id }}">
                            </span>
                            {% endfor %}
                        </div>

                        <!-- 标签选择器 -->
                        <div class="relative">
                            <input type="text" id="tag-search" placeholder="搜索或创建标签 (按Enter添加)..."
                                class="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm transition-shadow bg-white">

                            <!-- 标签下拉选项 -->
                            <div id="tag-dropdown"
                                class="absolute z-10 mt-1 w-full bg-white shadow-xl rounded-lg py-1 hidden max-h-60 overflow-auto border border-gray-100 ring-1 ring-black ring-opacity-5"
                                style="display: none;">
                                {% for tag in all_tags %}
                                <div class="px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-primary-50 hover:text-primary-700 tag-option transition-colors"
                                    data-tag-id="{{ tag.id }}" data-tag-name="{{ tag.name }}">
                                    {{ tag.name }}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <p class="mt-2 text-sm text-gray-500">输入标签名称并按Enter键添加，点击标签上的X按钮移除。</p>
                </div>

                <!-- SEO 设置 -->
                <div class="sm:col-span-6 pt-6 border-t border-gray-100">
                    <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                        <svg class="h-5 w-5 text-primary-500 mr-2" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        SEO 设置
                    </h3>
                </div>

                <div class="sm:col-span-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">SEO 标题</label>
                    <input type="text" name="seo_title" value="{{ post.seo_title or '' }}"
                        class="block w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm transition-shadow">
                    <p class="mt-1 text-xs text-gray-500">如果留空，将使用文章标题</p>
                </div>

                <div class="sm:col-span-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">SEO 描述</label>
                    <textarea name="seo_description" rows="3"
                        class="block w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm transition-shadow">{{ post.seo_description or '' }}</textarea>
                    <p class="mt-1 text-xs text-gray-500">如果留空，将使用文章摘要</p>
                </div>

                <div class="sm:col-span-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">SEO 关键词</label>
                    <input type="text" name="seo_keywords" value="{{ post.seo_keywords or '' }}"
                        class="block w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm transition-shadow">
                    <p class="mt-1 text-xs text-gray-500">多个关键词用逗号分隔</p>
                </div>

                <div class="sm:col-span-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">SEO Open Graph 图片</label>
                    <div class="flex gap-2">
                        <input type="text" name="seo_og_image" id="seo_og_image" value="{{ post.seo_og_image or '' }}"
                            class="block w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm transition-shadow">
                        <button type="button" id="openMediaLibrary"
                            class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-xl text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                            选择图片
                        </button>
                    </div>
                    <p class="mt-1 text-xs text-gray-500">如果留空，将使用特色图片</p>
                </div>
            </div>

            <div class="mt-8 pt-6 border-t border-gray-100 flex justify-end gap-4">
                <a href="{{ url_for('admin.posts') }}"
                    class="px-6 py-3 border border-gray-300 rounded-xl shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all">
                    取消
                </a>
                <button type="submit"
                    class="px-6 py-3 border border-transparent shadow-md text-sm font-medium rounded-xl text-white bg-gradient-to-r from-primary-600 to-purple-600 hover:from-primary-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all transform hover:-translate-y-0.5">
                    更新文章
                </button>
            </div>
        </form>
    </div>
</div>

<link href="https://unpkg.com/@wangeditor/editor@5.1.23/dist/css/style.css" rel="stylesheet">
<style>
    .w-e-toolbar {
        border-bottom: 1px solid #e5e7eb !important;
        background-color: #f9fafb !important;
    }

    .w-e-text-container {
        background-color: #fff !important;
    }

    .w-e-text-placeholder {
        top: 20px !important;
    }
</style>
<script src="https://unpkg.com/@wangeditor/editor@5.1.23/dist/index.js"></script>
<script src="{{ url_for('static', filename='js/tag-selector.js') }}"></script>
<script>
    let editor;
    let toolbarCreated = false;

    document.addEventListener('DOMContentLoaded', function () {
        if (typeof window.wangEditor === 'undefined') {
            console.error('wangEditor 未正确加载');
            return;
        }

        const E = window.wangEditor;
        const editorConfig = {
            placeholder: '请输入文章内容...',
            MENU_CONF: {},
            onChange(editor) {
                const html = editor.getHtml();
                document.getElementById('content').value = html;
            },
            onCreated(editor) {
                const contentValue = document.getElementById('content').value;
                if (contentValue) {
                    editor.setHtml(contentValue);
                }
            }
        };

        editorConfig.MENU_CONF['uploadImage'] = {
            server: '/media/upload',
            fieldName: 'file',
            maxFileSize: 2 * 1024 * 1024,
            maxNumberOfFiles: 10,
            allowedFileTypes: ['image/*'],
            customInsert(res, insertFn) {
                if (res.success && res.file_path) {
                    insertFn(res.file_path, res.original_filename || '', '');
                } else if (res.url) {
                    insertFn(res.url, res.alt || '', '');
                } else {
                    alert('上传失败或返回格式不正确');
                }
            }
        };

        if (!toolbarCreated) {
            editor = E.createEditor({
                selector: '#editor',
                config: editorConfig,
                mode: 'default'
            });

            const toolbar = E.createToolbar({
                editor: editor,
                selector: '#toolbar-container',
                mode: 'default'
            });

            toolbarCreated = true;
        }

        // 媒体库集成
        const openMediaBtn = document.getElementById('openMediaLibrary');
        if (openMediaBtn) {
            openMediaBtn.addEventListener('click', function () {
                window.open('/media/', 'mediaLibrary', 'width=800,height=600');
            });
        }

        window.addEventListener('message', function (event) {
            if (event.data && event.data.type === 'insertImage') {
                const imageData = event.data.image;
                if (imageData && imageData.url) {
                    // 如果是SEO图片输入框
                    const seoImageInput = document.getElementById('seo_og_image');
                    if (document.activeElement === seoImageInput || document.activeElement === openMediaBtn) {
                        seoImageInput.value = imageData.url;
                    }
                    // 否则插入到编辑器
                    else if (editor) {
                        editor.insertNode({
                            type: 'image',
                            src: imageData.url,
                            alt: imageData.alt || '图片',
                            style: { maxWidth: '100%' }
                        });
                    }
                }
            }
        });

        // 初始化标签选择器
        const tagSelector = new TagSelector({
            searchInput: '#tag-search',
            dropdown: '#tag-dropdown',
            selectedContainer: '#selected-tags',
            tagOption: '.tag-option',
            tagRemove: '.tag-remove',
            tagItem: '.tag-item'
        });
    });
</script>
{% endblock %}