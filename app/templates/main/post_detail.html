{% extends "base.html" %}
{% from 'macros/seo.html' import render_meta_tags %}
{% from 'macros/seo_utils.html' import get_seo_settings %}

{% block meta_tags %}
    {% set seo_data = get_post_seo_data(post) %}
    {{ render_meta_tags(
        title=seo_data.title,
        description=seo_data.description,
        keywords=seo_data.keywords,
        og_image=seo_data.og_image,
        canonical_url=seo_data.canonical_url
    ) }}
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto flex flex-col md:flex-row gap-8">
    <!-- 内容大纲 -->
    <div class="md:w-1/4 lg:w-1/5 hidden md:block sticky top-6 self-start">
        <div class="bg-white shadow rounded-lg p-4 border border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">文章目录</h3>
            <div id="toc-container" class="toc-list">
                <!-- 目录将通过JavaScript动态生成 -->
                <p class="text-gray-500 text-sm">正在加载目录...</p>
            </div>
        </div>
    </div>
    
    <!-- 文章内容 -->
    <div class="md:w-3/4 lg:w-4/5 mx-auto">
        <article class="bg-white shadow rounded-lg overflow-hidden">
            {% if post.featured_image %}
                <img class="w-full h-96 object-cover" src="{{ post.featured_image }}" alt="{{ post.title }}">
            {% endif %}
            
            <div class="p-6">
                <h1 class="text-3xl font-bold text-gray-900 mb-4">{{ post.title }}</h1>
                
                <div class="flex items-center text-sm text-gray-500 mb-6">
                    <span>作者: {{ post.author.username }}</span>
                    <span class="mx-2">•</span>
                    <span>{{ post.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                    {% if post.category %}
                        <span class="mx-2">•</span>
                        <span class="text-indigo-600">{{ post.category.name }}</span>
                    {% endif %}
                    <span class="mx-2">•</span>
                    <span>{{ post.view_count }} 次浏览</span>
                </div>
                
                <div class="prose max-w-none post-content" id="post-content">
                    {{ post.content|safe }}
                </div>
                
                {% if post.tags %}
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h3 class="text-sm font-medium text-gray-700 mb-3">相关标签</h3>
                        <div class="flex flex-wrap gap-2">
                            {% for tag in post.tags %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800 hover:bg-indigo-200 transition-colors duration-200 cursor-default">
                                {{ tag.name }}
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </article>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    /* 代码块样式 - 为Google Code Prettify和复制按钮准备 */
    .post-content pre {
        background-color: #f6f8fa;
        border-radius: 6px;
        padding: 40px 16px 16px 16px; /* 为复制按钮留出空间 */
        overflow: auto;
        font-size: 0.875em;
        line-height: 1.45;
        border: 1px solid #e1e4e8;
        margin: 16px 0;
        position: relative;
    }
    
    .post-content code {
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        padding: 2px 4px;
        background-color: #f6f8fa;
        border-radius: 3px;
        font-size: 0.875em;
        color: #e03131;
    }
    
    .post-content pre code {
        background: none;
        padding: 0;
        color: inherit;
    }
    
    /* 复制按钮样式 */
    .code-copy-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background-color: #e1e4e8;
        border: 1px solid #d1d5da;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 0.75rem;
        color: #24292e;
        cursor: pointer;
        transition: all 0.2s ease;
        z-index: 10;
    }
    
    .code-copy-btn:hover {
        background-color: #d1d5da;
    }
    
    .code-copy-btn.copied {
        background-color: #28a745;
        color: white;
        border-color: #28a745;
    }
    
    /* 大纲样式 */
    .toc-list {
        max-height: 70vh;
        overflow-y: auto;
    }
    
    .toc-item {
        margin: 8px 0;
        padding-left: 8px;
        border-left: 2px solid #e2e8f0;
        transition: all 0.2s ease;
    }
    
    .toc-item a {
        display: block;
        color: #4a5568;
        text-decoration: none;
        padding: 4px 0;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }
    
    .toc-item a:hover {
        color: #4f46e5;
        padding-left: 8px;
    }
    
    .toc-item--h2 {
        padding-left: 8px;
        border-left: 2px solid #e2e8f0;
    }
    
    .toc-item--h3 {
        padding-left: 24px;
        border-left: 2px solid #cbd5e0;
    }
    
    .toc-item--h4 {
        padding-left: 40px;
        border-left: 2px solid #e2e8f0;
    }
    
    .toc-item.active a {
        color: #4f46e5;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block scripts %}
<!-- Google Code Prettify 代码高亮 -->
<script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 为所有pre标签添加prettyprint类以启用代码高亮
        const preElements = document.querySelectorAll('.post-content pre');
        preElements.forEach(function(pre) {
            // 检查是否已有prettyprint类
            if (!pre.classList.contains('prettyprint')) {
                pre.classList.add('prettyprint');
            }
            
            // 为每个代码块添加复制按钮
            const copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = '复制';
            copyBtn.title = '复制代码';
            
            copyBtn.addEventListener('click', function() {
                // 获取代码内容
                let codeContent = '';
                if (pre.querySelector('code')) {
                    codeContent = pre.querySelector('code').textContent;
                } else {
                    codeContent = pre.textContent;
                }
                
                // 复制到剪贴板
                navigator.clipboard.writeText(codeContent).then(function() {
                    // 更新按钮状态
                    const originalText = copyBtn.textContent;
                    copyBtn.textContent = '已复制!';
                    copyBtn.classList.add('copied');
                    
                    // 2秒后恢复原始状态
                    setTimeout(function() {
                        copyBtn.textContent = originalText;
                        copyBtn.classList.remove('copied');
                    }, 2000);
                }).catch(function(err) {
                    console.error('复制失败: ', err);
                    alert('复制失败，请手动选择代码');
                });
            });
            
            pre.insertBefore(copyBtn, pre.firstChild);
        });
        
        // 如果pre标签内有code标签，尝试识别语言
        preElements.forEach(function(pre) {
            const codeElement = pre.querySelector('code');
            if (codeElement) {
                // 尝试从code标签的class中获取语言信息
                const codeClasses = codeElement.className.split(' ');
                const langClass = codeClasses.find(cls => cls.startsWith('language-'));
                if (langClass) {
                    const lang = langClass.replace('language-', '');
                    if (!pre.classList.contains(`lang-${lang}`)) {
                        pre.classList.add(`lang-${lang}`);
                    }
                }
            }
        });
        
        // 手动触发代码高亮
        if (window.PR) {
            window.PR.prettyPrint();
        }

        // 生成目录
        const content = document.getElementById('post-content');
        const headings = content.querySelectorAll('h1, h2, h3, h4, h5, h6');
        const tocContainer = document.getElementById('toc-container');
        
        if (headings.length === 0) {
            tocContainer.innerHTML = '<p class="text-gray-500 text-sm">文章中没有标题</p>';
            return;
        }
        
        tocContainer.innerHTML = ''; // 清空加载提示
        
        headings.forEach((heading, index) => {
            // 为标题添加ID，如果不存在的话
            if (!heading.id) {
                heading.id = 'heading-' + index;
            }
            
            // 创建目录项
            const tocItem = document.createElement('div');
            const level = parseInt(heading.tagName.charAt(1)); // 提取标题级别 (1, 2, 3...)
            tocItem.className = `toc-item toc-item--h${level}`;
            
            const link = document.createElement('a');
            link.href = '#' + heading.id;
            link.textContent = heading.textContent;
            link.onclick = function(e) {
                e.preventDefault();
                // 滚动到标题位置
                const targetElement = document.getElementById(heading.id);
                const offsetTop = targetElement.getBoundingClientRect().top + window.pageYOffset - 80; // 减去导航栏高度
                window.scrollTo({
                    top: offsetTop,
                    behavior: 'smooth'
                });
            };
            
            tocItem.appendChild(link);
            tocContainer.appendChild(tocItem);
        });
        
        // 监听滚动事件，高亮当前标题
        window.addEventListener('scroll', function() {
            const scrollPosition = window.scrollY + 100; // 添加偏移量以提前触发
            
            headings.forEach(heading => {
                const elementPosition = heading.offsetTop;
                
                // 移除所有高亮
                const tocItems = document.querySelectorAll('.toc-item');
                tocItems.forEach(item => item.classList.remove('active'));
                
                // 高亮当前标题
                if (scrollPosition >= elementPosition) {
                    const targetLink = document.querySelector(`a[href="#${heading.id}"]`);
                    if (targetLink) {
                        const tocItem = targetLink.parentNode;
                        tocItem.classList.add('active');
                    }
                }
            });
        });
    });
</script>
{% endblock %}